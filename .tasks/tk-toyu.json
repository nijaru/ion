{
  "project": "tk",
  "ref": "toyu",
  "title": "[AUTH] Google AI OAuth integration",
  "description": "Phase 3: Google OAuth endpoints, GoogleAi provider variant, ion login google command",
  "status": "open",
  "priority": 2,
  "labels": [],
  "assignees": [],
  "parent": null,
  "blocked_by": [
    "tk-7zp8"
  ],
  "estimate": null,
  "due_date": null,
  "logs": [
    {
      "ts": "2026-01-30T03:59:14.292Z",
      "msg": "OAuth infrastructure complete. GoogleAi provider integrated with:\n- Google OAuth flow (PKCE)\n- Token storage in ~/.config/ion/auth.json\n- TUI provider picker shows GoogleAi\n- Model fetching maps to Google models\nNeeds real-world testing with actual Google AI subscription."
    },
    {
      "ts": "2026-01-30T04:17:08.717Z",
      "msg": "Renamed from GoogleAi to Gemini. CLI: ion login gemini. Uses Gemini CLI client ID."
    },
    {
      "ts": "2026-01-30T04:37:18.696Z",
      "msg": "OAuth issue: Google API returns 'API key not valid' because llm-connector's GoogleProvider uses x-goog-api-key header, but OAuth tokens need Authorization: Bearer header. Need to either: (1) create custom HTTP client for OAuth, (2) contribute Bearer auth to llm-connector, or (3) use ConfigurableProtocol with custom auth."
    },
    {
      "ts": "2026-01-30T18:28:32.064Z",
      "msg": "Gemini OAuth login works but API calls fail. Consumer API (generativelanguage) only supports API keys. Code Assist API (cloudcode-pa) returns 403 Permission Denied with Gemini CLI client ID. May need Antigravity client ID or different scopes. Files: src/provider/gemini_oauth.rs, src/auth/google.rs"
    },
    {
      "ts": "2026-01-30T18:30:11.092Z",
      "msg": "Gemini OAuth login succeeds but API calls to Code Assist API return 403 Permission Denied. Tried: consumer API (no OAuth support), Code Assist v1internal format, model name mapping. May need different client ID or scopes"
    },
    {
      "ts": "2026-02-04T05:17:46.872Z",
      "msg": "Added Client-Metadata header matching Gemini CLI/pi-mono. Removed project field (not needed for personal Gemini subscriptions). Headers now: User-Agent, X-Goog-Api-Client, Client-Metadata with ideType/platform/pluginType. Still getting 500 errors - needs testing."
    },
    {
      "ts": "2026-02-04T05:20:43.993Z",
      "msg": "2026-02-03: Added Client-Metadata header (ideType/platform/pluginType), X-Goog-Api-Client header, removed project field (not needed for personal subscriptions). Headers now match Gemini CLI/pi-mono. Still getting 500 errors - compare full request payload with working CLI."
    },
    {
      "ts": "2026-02-04T05:43:49.728Z",
      "msg": "Adjusted Gemini OAuth request: ensure models/ prefix, add generation_config from request, optional x-goog-user-project header, separate Accept for stream, and endpoint fallback to autopush/daily on 5xx."
    },
    {
      "ts": "2026-02-04T05:57:18.007Z",
      "msg": "Adjusted x-goog-user-project header: only sent when ION_GEMINI_PROJECT is set (avoid accidental Cloud Project binding that triggers license error)."
    },
    {
      "ts": "2026-02-04T06:08:01.027Z",
      "msg": "Fish shell note: unset failed; Gemini still saw project license error likely due to old binary. Header now only sent when ION_GEMINI_PROJECT is set; rebuild required."
    },
    {
      "ts": "2026-02-04T17:59:06.441Z",
      "msg": "Gemini still returns 403 'configured to use a Google Cloud Project' after rebuild; likely ION_GEMINI_PROJECT set in environment. Added trim check; need env inspection."
    },
    {
      "ts": "2026-02-04T18:02:25.062Z",
      "msg": "Removed x-goog-user-project header entirely for Gemini OAuth to avoid Cloud Project license gating. Consumer subscriptions should not bind to project."
    }
  ],
  "created_at": "2026-01-30T03:12:45.222Z",
  "updated_at": "2026-02-04T18:02:25.062Z",
  "completed_at": null,
  "external": {}
}