{
  "project": "tk",
  "ref": "h5kw",
  "title": "[AUDIT] Provider switching - model selection, API keys",
  "description": null,
  "status": "done",
  "priority": 1,
  "labels": [],
  "assignees": [],
  "parent": null,
  "blocked_by": [],
  "estimate": null,
  "due_date": null,
  "logs": [
    {
      "ts": "2026-01-26T19:07:42.451Z",
      "msg": "Provider switching audit:\n\n**Provider Change Flow:**\n1. set_provider() creates new LLM Client\n2. Saves provider ID to config\n3. Re-creates Agent with new provider + same orchestrator  \n4. Updates model registry (only for OpenRouter)\n5. Clears models, sets loading state\n6. Conversation history preserved (session.messages unchanged)\n\n**Model Selection Flow:**\n1. Select model from picker\n2. session.model = model.id\n3. context_window updated on agent\n4. config.model persisted\n5. needs_setup cleared if in setup flow\n\n**Potential Issues:**\n\n1. **Model registry only updates for OpenRouter** - Line 460-465 only recreates registry for OpenRouter. Other providers might get stale registry.\n\n2. **No validation that model matches provider** - After provider switch, session.model might refer to a model from the old provider. First API call would fail with unknown model error.\n\n3. **Conversation context compatibility** - Mid-conversation provider switches preserve messages. Different providers may handle tool_result, thinking blocks differently. Could cause API errors.\n\nThese are edge cases that would cause clear errors, not silent bugs."
    }
  ],
  "created_at": "2026-01-26T18:59:21.184Z",
  "updated_at": "2026-01-26T19:07:46.515Z",
  "completed_at": "2026-01-26T19:07:46.515Z",
  "external": {}
}