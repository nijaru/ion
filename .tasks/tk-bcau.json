{
  "project": "tk",
  "ref": "bcau",
  "title": "[ARCH] Soft-wrap chat history + bottom-ui viewport separation",
  "description": "Adopt append-only soft-wrapped chat history to preserve native terminal scrollback/search across resize, while keeping bottom UI as ephemeral region with dynamic ui_top. Remove width-coupled full-history reflow on resize and replace with viewport-state transitions that avoid chat duplication.",
  "status": "done",
  "priority": 2,
  "labels": [],
  "assignees": [],
  "parent": null,
  "blocked_by": [],
  "estimate": null,
  "due_date": null,
  "logs": [
    {
      "ts": "2026-02-12T07:15:10.050Z",
      "msg": "Design locked: append-only soft-wrapped chat history + ephemeral bottom UI, resize should repaint UI plane without full-history reflow. Spec: ai/design/chat-softwrap-scrollback-2026-02.md"
    },
    {
      "ts": "2026-02-13T01:18:21.135Z",
      "msg": "User requested a full RNK-idiomatic src/tui architecture design (not spike-aligned). Preparing concrete target module layout, state/render boundaries, and migration sequence."
    },
    {
      "ts": "2026-02-13T01:19:23.725Z",
      "msg": "Published concrete RNK-first target architecture for src/tui in ai/design/tui-v3-architecture-2026-02.md: state/update/frame/render/runtime split, single render engine, chat-plane vs UI-plane contracts, and phased migration plan."
    },
    {
      "ts": "2026-02-13T01:49:25.640Z",
      "msg": "Implemented resize contract pass: Event::Resize now schedules canonical chat reflow; row-addressed repaint path in run.rs no longer writes newlines (write_to_width instead of writeln_with_width), preventing resize-induced blank-line accumulation and transcript duplication while preserving viewport repaint semantics."
    },
    {
      "ts": "2026-02-13T01:56:51.870Z",
      "msg": "Patched prepare_frame overlap logic: when resize reflow is already requested, skip ScrollViewport pre-op so resize does not push existing viewport lines into scrollback (observed duplicate startup header blocks)."
    },
    {
      "ts": "2026-02-13T02:12:03.239Z",
      "msg": "Handled resize+streaming duplication path: reflow now includes previously committed streaming lines (safe subset) and preserves streaming_lines_rendered across reflow. Prevents re-emitting already-shown streaming blocks after resize."
    },
    {
      "ts": "2026-02-13T02:13:24.786Z",
      "msg": "Formatting pass from user feedback: agent multiline rendering no longer prepends non-semantic two-space prefix on every line; markdown unordered list marker normalized to '-' (from '*') with highlight tests updated."
    },
    {
      "ts": "2026-02-13T20:39:13.407Z",
      "msg": "2026-02-13: Streaming finalize path fixed in src/tui/render/chat.rs: apply_stable_agent_carryover now always preserves a trailing separator blank line after committed carryover so adjacent agent messages do not collapse without spacing. Added unit coverage and validated full suite (472 pass)."
    },
    {
      "ts": "2026-02-14T08:57:41.943Z",
      "msg": "2026-02-14: Core soft-wrap + reflow + viewport separation all landed in main. Resize handling, streaming finalize, RNK rendering all working. Closing â€” remaining edge cases (if any) should be filed as separate bugs."
    }
  ],
  "created_at": "2026-02-12T07:14:22.997Z",
  "updated_at": "2026-02-14T08:57:41.975Z",
  "completed_at": "2026-02-14T08:57:41.975Z",
  "external": {}
}