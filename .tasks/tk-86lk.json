{
  "project": "tk",
  "ref": "86lk",
  "title": "[BUG] --continue header pinning breaks scrollback",
  "description": "In TUI resume/continue flow, header appears pinned to top and bottom fills with blank lines while scrolling. Desired behavior: bottom UI stays locked; top/header should not be force-pinned except when actively composing input.",
  "status": "active",
  "priority": 2,
  "labels": [],
  "assignees": [],
  "parent": null,
  "blocked_by": [],
  "estimate": null,
  "due_date": null,
  "logs": [
    {
      "ts": "2026-02-11T01:13:47.269Z",
      "msg": "Starting investigation in run/render_state resume path. Goal: stop header pinning and bottom newline accumulation during scrollback in --continue."
    },
    {
      "ts": "2026-02-11T01:18:31.283Z",
      "msg": "Root cause: startup resume path sets ChatPosition::Tracking when history fits viewport (position_after_reprint), which top-anchors UI/header and leaves large blank region. Patched run.rs to force Scrolling mode after resume reprint."
    },
    {
      "ts": "2026-02-11T01:18:39.230Z",
      "msg": "Validation: cargo test passed (434 tests)."
    },
    {
      "ts": "2026-02-11T01:32:27.015Z",
      "msg": "Adjusted startup resume reprint: when history is shorter than available chat rows, apply ScrollDown padding so content is bottom-aligned above UI (no top pinning for short history). Keep position Scrolling for bottom-locked UI."
    },
    {
      "ts": "2026-02-11T01:40:25.553Z",
      "msg": "Re-evaluating fix quality: user reports current behavior still wrong. Performing full resume render-path audit to replace startup padding workaround with source-level layouted reprint."
    },
    {
      "ts": "2026-02-11T01:41:45.103Z",
      "msg": "Replaced workaround with source-level startup resume layout: build lines first, compute available chat rows, render short histories at computed start_row above UI, render long histories from top with overflow trim; mark reflow complete and force Scrolling mode."
    },
    {
      "ts": "2026-02-11T01:49:33.470Z",
      "msg": "User requested no alignment. Updated startup resume path to render history from row 0 and only trim overflow for UI. Removed short-history start-row alignment logic."
    },
    {
      "ts": "2026-02-11T01:50:15.891Z",
      "msg": "Fix follow-up: cap resume overflow trim to visible viewport (min(line_count, term_height)) to avoid overscroll on long histories."
    },
    {
      "ts": "2026-02-11T02:58:53.458Z",
      "msg": "Adopted requested behavior: resume now uses position_after_reprint state directly (Tracking when chat+UI fits, Scrolling only on overflow). Removed forced Scrolling override."
    },
    {
      "ts": "2026-02-11T03:31:14.747Z",
      "msg": "Review pass: found state-order bug in in-session /resume path. load_session() resets render_state.position=Empty (src/tui/session/lifecycle.rs:53), prepare_frame queues PrintHeader and chat_lines in same frame (src/tui/run.rs:135-144), but plan_chat_insert uses pre-op state before pre-ops run (src/tui/run.rs:695-704) so Empty maps to ScrollInsert (src/tui/run.rs:194-201). This can misplace chat/UI and reintroduce pinning/blank-line artifacts for /resume via selector."
    },
    {
      "ts": "2026-02-11T03:31:18.574Z",
      "msg": "Review pass: /clear currently over-scrolls full viewport after reset. /clear sets render_state to Empty then needs_screen_clear (src/tui/events.rs:487-490). prepare_frame computes scroll_amount from Empty (src/tui/run.rs:96-103), and ChatPosition::Empty.scroll_amount returns term_height (src/tui/render_state.rs:148), so ClearScreen uses ScrollUp(term_height) (src/tui/run.rs:233-238) and pushes blank lines into scrollback."
    },
    {
      "ts": "2026-02-11T03:31:22.697Z",
      "msg": "Validation: cargo test -q passes (434 tests). No compile regressions in current tree."
    },
    {
      "ts": "2026-02-11T03:46:17.592Z",
      "msg": "Implementing source-level fix plan: 1) in-session /resume triggers full reflow and suppresses selector-clear-only path, 2) reflow frame suppresses incremental chat insert to avoid duplicate/stale planning, 3) /clear uses full viewport clear when state already reset to Empty, 4) ScrollInsert updates render_state.position."
    },
    {
      "ts": "2026-02-11T03:47:54.157Z",
      "msg": "Implemented fixes: run.rs now treats /clear reset path as full viewport clear (no ScrollUp blank rows), schedules no incremental chat insertion during reflow frames, updates position after ScrollInsert, and plans ChatPosition::Empty as tracking-until-overflow. events.rs session selection now triggers needs_reflow and suppresses selector-clear path after successful load. render_state.rs reset_for_session_load now preserves position to compute accurate pre-reflow scroll amount."
    },
    {
      "ts": "2026-02-11T03:49:48.644Z",
      "msg": "Post-fix validation: cargo test -q passes (434 tests)."
    },
    {
      "ts": "2026-02-11T04:54:39.928Z",
      "msg": "Context-save handoff (2026-02-11): source-level run/events/render_state fixes are committed and lean regression tests were added in follow-up; remaining work is manual visual verification + resize/selector edge-case sweep under Sprint 16 before closing this bug."
    },
    {
      "ts": "2026-02-11T05:56:07.787Z",
      "msg": "Applied two source updates: 1) ChatPosition::Empty scroll_amount now returns 0 (was term_height) to avoid blank-line overscroll in empty-state reflow paths, 2) normalized TUI separator glyphs from '·' to '•' in events/status/progress/selector UI strings. cargo test -q: 436 passing."
    },
    {
      "ts": "2026-02-11T05:56:47.184Z",
      "msg": "Residual edge to verify: in pre-message states (Header/Empty), ui_drawn_at is not tracked, so popup/selector height shrink could leave stale rows above current top. Not reproduced yet; include in manual checklist during resize/completer/selector transitions before closing."
    },
    {
      "ts": "2026-02-11T06:02:45.528Z",
      "msg": "Implemented selector-clear source fix for Header/Empty edge cases: added RenderState.selector_clear_from queue/cancel/take methods, captured selector top on exit_selector_mode(), and changed run.rs PreOp::ClearSelectorArea to clear from captured row instead of recomputed input layout top. This prevents stale selector rows above UI when selector height shrinks while avoiding chat-area over-clear. Added unit test selector_clear_queue_take_cancel. cargo test -q: 437 passed."
    },
    {
      "ts": "2026-02-11T06:04:06.433Z",
      "msg": "Follow-up hardening: tracked last selector render top in RenderState (note_selector_top called from draw_direct in selector mode) and queue_selector_clear now falls back to that top when position.last_ui_top is unavailable (Header/Empty). This closes the remaining pre-message selector-clear gap identified in prior note. cargo test -q still 437 passed."
    },
    {
      "ts": "2026-02-11T06:04:58.443Z",
      "msg": "Added frame-order guard in prepare_frame: if selector clear and reflow are both pending, selector clear is canceled so it cannot run after reflow and erase newly reprinted chat rows. This narrows resize/selector transition regressions. cargo test -q remains 437 passing."
    }
  ],
  "created_at": "2026-02-11T01:13:44.111Z",
  "updated_at": "2026-02-11T06:04:58.443Z",
  "completed_at": null,
  "external": {}
}